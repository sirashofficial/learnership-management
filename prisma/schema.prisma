generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(uuid())
  email       String       @unique
  name        String
  password    String
  role        String       @default("FACILITATOR")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  lessonPlans LessonPlan[]
  sessions    Session[]
  students    Student[]
  plans       Plan[]       @relation("PlanFacilitator")
  reminderPreference ReminderPreference?
}

model Group {
  id                   String                @id @default(uuid())
  name                 String
  location             String?
  address              String?
  contactName          String?
  contactPhone         String?
  coordinator          String?
  startDate            DateTime
  endDate              DateTime
  status               String                @default("ACTIVE")
  notes                String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  companyId            String?
  Company              Company?              @relation(fields: [companyId], references: [id])
  courses              GroupCourse[]
  rolloutPlan          GroupRolloutPlan?
  schedules            GroupSchedule[]
  lessonPlans          LessonPlan[]
  sessions             Session[]
  students             Student[]
  unitStandardRollouts UnitStandardRollout[]
  
  // Calendar feature relations
  plans                Plan[]     // Lesson plans for calendar
}

model GroupRolloutPlan {
  id               String    @id @default(uuid())
  groupId          String    @unique
  module1StartDate DateTime?
  module1EndDate   DateTime?
  module2StartDate DateTime?
  module2EndDate   DateTime?
  module3StartDate DateTime?
  module3EndDate   DateTime?
  module4StartDate DateTime?
  module4EndDate   DateTime?
  module5StartDate DateTime?
  module5EndDate   DateTime?
  module6StartDate DateTime?
  module6EndDate   DateTime?
  rolloutDocPath   String?
  group            Group     @relation(fields: [groupId], references: [id])
}

model UnitStandardRollout {
  id             String       @id @default(uuid())
  groupId        String
  unitStandardId String
  startDate      DateTime?
  endDate        DateTime?
  summativeDate  DateTime?
  assessingDate  DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  unitStandard   UnitStandard @relation(fields: [unitStandardId], references: [id])
  group          Group        @relation(fields: [groupId], references: [id])

  @@unique([groupId, unitStandardId])
}

model Student {
  id                   String                 @id @default(uuid())
  studentId            String                 @unique
  firstName            String
  lastName             String
  email                String?
  phone                String?
  idNumber             String?
  progress             Int                    @default(0)
  totalCreditsEarned   Int                    @default(0)
  status               String                 @default("ACTIVE")
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  groupId              String
  facilitatorId        String
  currentModuleId      String?
  assessments          Assessment[]
  attendance           Attendance[]
  courseProgress       CourseProgress[]
  formativeCompletions FormativeCompletion[]
  moduleProgress       ModuleProgress[]
  poeChecklists        POEChecklist?
  currentModule        Module?                @relation(fields: [currentModuleId], references: [id])
  facilitator          User                   @relation(fields: [facilitatorId], references: [id])
  group                Group                  @relation(fields: [groupId], references: [id])
  unitStandardProgress UnitStandardProgress[]
}

model FormativeAssessment {
  id             String                @id @default(uuid())
  code           String                @unique
  title          String
  description    String?
  documentPath   String?
  questions      Int?
  passingScore   Int                   @default(50)
  order          Int                   @default(0)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  moduleId       String
  unitStandardId String
  unitStandard   UnitStandard          @relation(fields: [unitStandardId], references: [id])
  module         Module                @relation(fields: [moduleId], references: [id])
  completions    FormativeCompletion[]
}

model FormativeCompletion {
  id               String              @id @default(uuid())
  completedDate    DateTime?
  score            Int?
  passed           Boolean             @default(false)
  attempts         Int                 @default(1)
  moderationStatus String              @default("PENDING")
  moderatedBy      String?
  moderatedDate    DateTime?
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  studentId        String
  formativeId      String
  formative        FormativeAssessment @relation(fields: [formativeId], references: [id])
  student          Student             @relation(fields: [studentId], references: [id])

  @@unique([studentId, formativeId])
  @@index([studentId])
  @@index([formativeId])
}

model Session {
  id            String       @id @default(uuid())
  title         String
  module        String
  date          DateTime
  startTime     String
  endTime       String
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  groupId       String
  facilitatorId String
  attendance    Attendance[]
  facilitator   User         @relation(fields: [facilitatorId], references: [id])
  group         Group        @relation(fields: [groupId], references: [id])
}

model Attendance {
  id         String    @id @default(uuid())
  date       DateTime
  status     String
  notes      String?
  markedBy   String?
  markedAt   DateTime?
  qrCodeScan Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  studentId  String
  sessionId  String?
  groupId    String?
  session    Session?  @relation(fields: [sessionId], references: [id])
  student    Student   @relation(fields: [studentId], references: [id])

  @@unique([studentId, date, groupId])
  @@index([date])
  @@index([studentId, date])
  @@index([groupId, date])
}

model AttendancePolicy {
  id                  String   @id @default(uuid())
  name                String
  description         String?
  minimumPercentage   Int      @default(80)
  consecutiveAbsences Int      @default(3)
  warningThreshold    Int      @default(75)
  criticalThreshold   Int      @default(60)
  notifyOnAbsence     Boolean  @default(true)
  notifyOnWarning     Boolean  @default(true)
  notifyOnCritical    Boolean  @default(true)
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model AttendanceAlert {
  id               String    @id @default(uuid())
  type             String
  severity         String
  message          String
  details          String?
  resolved         Boolean   @default(false)
  resolvedAt       DateTime?
  resolvedBy       String?
  notificationSent Boolean   @default(false)
  studentId        String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([studentId])
  @@index([type])
  @@index([resolved])
}

model AttendanceReport {
  id          String   @id @default(uuid())
  title       String
  type        String
  startDate   DateTime
  endDate     DateTime
  format      String
  filePath    String?
  generatedBy String
  parameters  String?
  createdAt   DateTime @default(now())
}

model Assessment {
  id               String       @id @default(uuid())
  type             String
  method           String
  result           String?
  score            Int?
  assessedDate     DateTime?
  dueDate          DateTime
  notes            String?
  feedback         String?
  moderationStatus String       @default("PENDING")
  moderatedBy      String?
  moderatedDate    DateTime?
  moderationNotes  String?
  attemptNumber    Int          @default(1)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  studentId        String
  unitStandardId   String
  unitStandard     UnitStandard @relation(fields: [unitStandardId], references: [id])
  student          Student      @relation(fields: [studentId], references: [id])

  @@index([unitStandardId])
  @@index([studentId, unitStandardId])
  @@index([studentId, result])
}

model ModuleProgress {
  id             String    @id @default(uuid())
  status         String    @default("NOT_STARTED")
  progress       Int       @default(0)
  creditsEarned  Int       @default(0)
  startDate      DateTime?
  completionDate DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  studentId      String
  moduleId       String
  module         Module    @relation(fields: [moduleId], references: [id])
  student        Student   @relation(fields: [studentId], references: [id])

  @@unique([studentId, moduleId])
}

model UnitStandardProgress {
  id               String       @id @default(uuid())
  status           String       @default("NOT_STARTED")
  startDate        DateTime?
  completionDate   DateTime?
  formativesPassed Int          @default(0)
  summativePassed  Boolean      @default(false)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  studentId        String
  unitStandardId   String
  unitStandard     UnitStandard @relation(fields: [unitStandardId], references: [id])
  student          Student      @relation(fields: [studentId], references: [id])

  @@unique([studentId, unitStandardId])
}

model POEChecklist {
  id                String    @id @default(uuid())
  module1POE        Boolean   @default(false)
  module1POEDate    DateTime?
  module2POE        Boolean   @default(false)
  module2POEDate    DateTime?
  module3POE        Boolean   @default(false)
  module3POEDate    DateTime?
  module4POE        Boolean   @default(false)
  module4POEDate    DateTime?
  module5POE        Boolean   @default(false)
  module5POEDate    DateTime?
  module6POE        Boolean   @default(false)
  module6POEDate    DateTime?
  assessmentsSigned Boolean   @default(false)
  assessmentsDate   DateTime?
  logbookComplete   Boolean   @default(false)
  logbookSigned     Boolean   @default(false)
  logbookDate       DateTime?
  idCopyPresent     Boolean   @default(false)
  idCopyDate        DateTime?
  contractSigned    Boolean   @default(false)
  contractDate      DateTime?
  inductionComplete Boolean   @default(false)
  inductionDate     DateTime?
  verifiedBy        String?
  verifiedDate      DateTime?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  studentId         String    @unique
  student           Student   @relation(fields: [studentId], references: [id])
}

model POEFile {
  id          String   @id @default(uuid())
  fileName    String
  fileSize    Int
  fileType    String
  filePath    String
  description String?
  uploadedAt  DateTime @default(now())
}

model Module {
  id                   String                @id @default(uuid())
  moduleNumber         Int                   @unique
  code                 String                @unique
  name                 String
  fullName             String
  purpose              String
  description          String?
  credits              Int
  notionalHours        Int
  classroomHours       Int
  workplaceHours       Int
  order                Int
  status               String                @default("ACTIVE")
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  documents            CurriculumDocument[]
  embeddings           CurriculumEmbedding[]
  formativeAssessments FormativeAssessment[]
  lessonPlans          LessonPlan[]
  progress             ModuleProgress[]
  students             Student[]
  unitStandards        UnitStandard[]
}

model CurriculumEmbedding {
  id        String   @id @default(uuid())
  content   String
  embedding String
  metadata  String?
  createdAt DateTime @default(now())
  moduleId  String
  module    Module   @relation(fields: [moduleId], references: [id])
}

model DocumentChunk {
  id         String   @id @default(cuid())
  content    String
  filename   String
  filePath   String
  category   String
  tags       String
  chunkIndex Int
  createdAt  DateTime @default(now())

  @@index([category])
  @@index([filename])
}

model UnitStandard {
  id                   String                 @id @default(uuid())
  code                 String                 @unique
  title                String
  credits              Int
  level                Int
  type                 String
  content              String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  moduleId             String
  activities           Activity[]
  assessments          Assessment[]
  formativeAssessments FormativeAssessment[]
  module               Module                 @relation(fields: [moduleId], references: [id])
  progress             UnitStandardProgress[]
  unitStandardRollouts UnitStandardRollout[]
}

model Activity {
  id             String       @id @default(uuid())
  description    String
  duration       Int
  resources      String?
  assessmentType String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  unitStandardId String
  unitStandard   UnitStandard @relation(fields: [unitStandardId], references: [id])
}

model LessonPlan {
  id            String   @id @default(uuid())
  title         String
  description   String?
  date          DateTime
  startTime     String
  endTime       String
  venue         String?
  objectives    String?
  materials     String?
  activities    String?
  notes         String?
  aiGenerated   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  moduleId      String
  facilitatorId String
  groupId       String?
  group         Group?   @relation(fields: [groupId], references: [id])
  facilitator   User     @relation(fields: [facilitatorId], references: [id])
  module        Module   @relation(fields: [moduleId], references: [id])
}

model CurriculumDocument {
  id          String   @id @default(uuid())
  title       String
  fileName    String
  fileSize    Int
  fileType    String
  filePath    String
  description String?
  category    String
  version     String   @default("1.0")
  uploadedAt  DateTime @default(now())
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id])
}

model GroupCourse {
  id        String   @id @default(uuid())
  status    String   @default("PLANNED")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
}

model CourseProgress {
  id        String   @id @default(uuid())
  progress  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
}

model RecurringSessionOverride {
  id                  String   @id @default(uuid())
  date                DateTime
  groupName           String
  venue               String
  isCancelled         Boolean  @default(false)
  cancellationReason  String?
  notes               String?
  notificationEnabled Boolean  @default(true)
  notificationSent    Boolean  @default(false)
  notificationTime    Int      @default(30)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([date, groupName, venue])
}

model ScheduleTemplate {
  id          String          @id @default(uuid())
  name        String
  description String?
  isActive    Boolean         @default(true)
  schedule    String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  groups      GroupSchedule[]
}

model GroupSchedule {
  id         String           @id @default(uuid())
  startDate  DateTime
  endDate    DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  groupId    String
  templateId String
  template   ScheduleTemplate @relation(fields: [templateId], references: [id])
  group      Group            @relation(fields: [groupId], references: [id])

  @@index([groupId])
  @@index([templateId])
}

// Calendar Feature Models
model Plan {
  id          String    @id @default(uuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  groupId     String
  facilitatorId String
  venue       String?
  objectives  String?
  materials   String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  group       Group     @relation(fields: [groupId], references: [id])
  facilitator User      @relation("PlanFacilitator", fields: [facilitatorId], references: [id])
  reminders   Reminder[]
  
  @@index([groupId])
  @@index([facilitatorId])
}

model Reminder {
  id          String    @id @default(uuid())
  planId      String
  message     String?
  venue       String?
  sendTo      String?   // Comma-separated email addresses
  scheduledAt DateTime
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  plan        Plan      @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  @@index([planId])
  @@index([scheduledAt])
}

model ReminderPreference {
  id                           String    @id @default(uuid())
  userId                       String    @unique
  emailRemindersEnabled        Boolean   @default(true)
  browserNotificationsEnabled  Boolean   @default(true)
  quietHoursStart              String?   // Format: "HH:MM"
  quietHoursEnd                String?   // Format: "HH:MM"
  timeZone                     String    @default("UTC")
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Company {
  id            String   @id
  name          String
  address       String?
  contactPerson String?
  email         String?
  phone         String?
  industry      String?
  status        String   @default("ACTIVE")
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  Group         Group[]
}
