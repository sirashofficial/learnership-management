'use client';

import { useState, useMemo } from 'react';
import useSWR from 'swr';
import { useGroups } from '@/contexts/GroupsContext';
import Sidebar from '@/components/Sidebar';
import Header from '@/components/Header';
import LessonDetailsModal from '@/components/LessonDetailsModal';
import AddLessonModal from '@/components/AddLessonModal';
import MonthView from '@/components/MonthView';
import ListView from '@/components/ListView';
import TimelineView from '@/components/TimelineView';
import FilterPanel from '@/components/FilterPanel';
import {
  ChevronLeft,
  ChevronRight,
  Plus,
  Copy,
  Printer,
  ChevronDown,
  ChevronUp,
  Calendar,
  Filter,
  List,
  Clock,
  LayoutGrid,
} from 'lucide-react';
import {
  startOfWeek,
  endOfWeek,
  format,
  addWeeks,
  subWeeks,
  parseISO,
  isSameDay,
  addDays,
} from 'date-fns';

interface Lesson {
  id: string;
  title: string;
  description: string | null;
  date: string;
  startTime: string;
  endTime: string;
  venue: string | null;
  module: {
    id: string;
    code: string;
    name: string;
  };
  facilitator: {
    id: string;
    name: string;
    email: string;
  } | null;
  group: {
    id: string;
    name: string;
    company: {
      id: string;
      name: string;
    };
  };
}

interface ParentGroup {
  id: string;
  name: string;
  subGroups: {
    id: string;
    name: string;
    room: 'Lecture Room' | 'Computer Lab';
  }[];
}

const fetcher = (url: string) => fetch(url).then((res) => res.json());

// UX IMPROVEMENT: Color code by GROUP for quick recognition, not room
const GROUP_COLORS: { [key: string]: { bg: string; border: string; text: string; hover: string } } = {
  'Azelis 25\'': { bg: 'bg-teal-500', border: 'border-teal-600', text: 'text-white', hover: 'hover:bg-teal-600' },
  'Packaging World 25\'': { bg: 'bg-cyan-500', border: 'border-cyan-600', text: 'text-white', hover: 'hover:bg-cyan-600' },
  'Flint Group 25\'': { bg: 'bg-indigo-500', border: 'border-indigo-600', text: 'text-white', hover: 'hover:bg-indigo-600' },
  'Wahl 25\'': { bg: 'bg-purple-500', border: 'border-purple-600', text: 'text-white', hover: 'hover:bg-purple-600' },
  'Monteagle 25\'': { bg: 'bg-pink-500', border: 'border-pink-600', text: 'text-white', hover: 'hover:bg-pink-600' },
  'Monteagle 26\'': { bg: 'bg-rose-500', border: 'border-rose-600', text: 'text-white', hover: 'hover:bg-rose-600' },
  'default': { bg: 'bg-slate-500', border: 'border-slate-600', text: 'text-white', hover: 'hover:bg-slate-600' },
};

const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

export default function TimetablePage(): JSX.Element {
  const [currentDate, setCurrentDate] = useState(new Date('2026-02-09'));
  const [viewType, setViewType] = useState<'week' | 'month' | 'list' | 'timeline'>('week'); // Phase 2: Multiple view types
  const [viewMode, setViewMode] = useState<'simple' | 'detailed'>('simple'); // UX: Simplified from parent/subgroup
  const [highlightedGroup, setHighlightedGroup] = useState<string | null>(null);
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [hoveredLesson, setHoveredLesson] = useState<string | null>(null); // UX: Show details on hover
  const [densityMode, setDensityMode] = useState<'compact' | 'comfortable' | 'spacious'>('comfortable'); // UX: Density control
  const [selectedLesson, setSelectedLesson] = useState<Lesson | null>(null);
  const [showLessonDetails, setShowLessonDetails] = useState(false);
  const [showAddLesson, setShowAddLesson] = useState(false);
  const [editingLesson, setEditingLesson] = useState<Lesson | null>(null);
  const [addLessonDefaults, setAddLessonDefaults] = useState<{ date?: string; venue?: string }>({});
  // Phase 3: Filter and Search state
  const [selectedGroupFilters, setSelectedGroupFilters] = useState<string[]>([]);
  const [selectedModuleFilters, setSelectedModuleFilters] = useState<string[]>([]);
  const [selectedFacilitatorFilters, setSelectedFacilitatorFilters] = useState<string[]>([]);
  const [searchQuery, setSearchQuery] = useState('');

  const { groups } = useGroups();

  // Calculate date range for the week
  const dateRange = useMemo(() => {
    return {
      start: startOfWeek(currentDate, { weekStartsOn: 1 }),
      end: endOfWeek(currentDate, { weekStartsOn: 1 }),
    };
  }, [currentDate]);

  // Build API URL
  const apiUrl = useMemo(() => {
    const params = new URLSearchParams({
      startDate: format(dateRange.start, 'yyyy-MM-dd'),
      endDate: format(dateRange.end, 'yyyy-MM-dd'),
    });
    return `/api/timetable?${params.toString()}`;
  }, [dateRange]);

  const { data, error, isLoading, mutate } = useSWR<{ lessons: Lesson[] }>(
    apiUrl,
    fetcher
  );

  const lessons = data?.lessons || [];

  // Fetch modules and facilitators for the add/edit modal
  const { data: modulesData } = useSWR('/api/modules', fetcher);
  const { data: facilitatorsData } = useSWR('/api/users', fetcher);
  
  const modules = modulesData?.modules || [];
  const facilitators = facilitatorsData?.users || [];

  // Phase 3: Filter and search lessons
  const filteredLessons = useMemo(() => {
    let filtered = [...lessons];

    // Apply group filter
    if (selectedGroupFilters.length > 0) {
      filtered = filtered.filter(lesson => selectedGroupFilters.includes(lesson.group.id));
    }

    // Apply module filter
    if (selectedModuleFilters.length > 0) {
      filtered = filtered.filter(lesson => selectedModuleFilters.includes(lesson.module.id));
    }

    // Apply facilitator filter
    if (selectedFacilitatorFilters.length > 0) {
      filtered = filtered.filter(lesson => 
        lesson.facilitator && selectedFacilitatorFilters.includes(lesson.facilitator.id)
      );
    }

    // Apply search query
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(lesson =>
        lesson.title.toLowerCase().includes(query) ||
        lesson.description?.toLowerCase().includes(query) ||
        lesson.module.name.toLowerCase().includes(query) ||
        lesson.module.code.toLowerCase().includes(query) ||
        lesson.group.name.toLowerCase().includes(query) ||
        lesson.venue?.toLowerCase().includes(query)
      );
    }

    return filtered;
  }, [lessons, selectedGroupFilters, selectedModuleFilters, selectedFacilitatorFilters, searchQuery]);

  // Prepare filter options with counts
  const filterOptions = useMemo(() => {
    const groupCounts: Record<string, number> = {};
    const moduleCounts: Record<string, number> = {};
    const facilitatorCounts: Record<string, number> = {};

    lessons.forEach(lesson => {
      groupCounts[lesson.group.id] = (groupCounts[lesson.group.id] || 0) + 1;
      moduleCounts[lesson.module.id] = (moduleCounts[lesson.module.id] || 0) + 1;
      if (lesson.facilitator) {
        facilitatorCounts[lesson.facilitator.id] = (facilitatorCounts[lesson.facilitator.id] || 0) + 1;
      }
    });

    return {
      groups: groups.map(g => ({ id: g.id, name: g.name, count: groupCounts[g.id] || 0 })),
      modules: modules.map((m: any) => ({ id: m.id, name: m.name, count: moduleCounts[m.id] || 0 })),
      facilitators: facilitators.map((f: any) => ({ id: f.id, name: f.name, count: facilitatorCounts[f.id] || 0 }))
    };
  }, [groups, modules, facilitators, lessons]);

  const clearAllFilters = () => {
    setSelectedGroupFilters([]);
    setSelectedModuleFilters([]);
    setSelectedFacilitatorFilters([]);
    setSearchQuery('');
  };

  // Navigation
  const handlePrevious = () => setCurrentDate(subWeeks(currentDate, 1));
  const handleNext = () => setCurrentDate(addWeeks(currentDate, 1));

  // Get lessons for specific day and room
  const getLessonsForDayRoom = (dayIndex: number, room: 'Lecture Room' | 'Computer Lab') => {
    const targetDate = addDays(dateRange.start, dayIndex);
    return filteredLessons.filter((lesson) => {
      const lessonDate = parseISO(lesson.date);
      return isSameDay(lessonDate, targetDate) && lesson.venue === room;
    });
  };

  // Print view
  const handlePrint = () => {
    setTimeout(() => window.print(), 100);
  };

  // CRUD Operations
  const handleLessonClick = (lesson: Lesson) => {
    setSelectedLesson(lesson);
    setShowLessonDetails(true);
  };

  const handleAddLesson = (date?: string, venue?: string) => {
    setAddLessonDefaults({ date, venue });
    setShowAddLesson(true);
    setEditingLesson(null);
  };

  const handleEditLesson = () => {
    setEditingLesson(selectedLesson);
    setShowLessonDetails(false);
    setShowAddLesson(true);
  };

  const handleDeleteLesson = async () => {
    if (!selectedLesson) return;
    
    if (confirm(`Are you sure you want to delete "${selectedLesson.title}"?`)) {
      try {
        const response = await fetch(`/api/timetable/${selectedLesson.id}`, {
          method: 'DELETE',
        });

        if (response.ok) {
          setShowLessonDetails(false);
          setSelectedLesson(null);
          // Refresh data
          mutate();
          alert('Lesson deleted successfully!');
        } else {
          alert('Failed to delete lesson');
        }
      } catch (error) {
        console.error('Error deleting lesson:', error);
        alert('Error deleting lesson');
      }
    }
  };

  const handleSubmitLesson = async (lessonData: any) => {
    try {
      const url = editingLesson 
        ? `/api/timetable/${editingLesson.id}`
        : '/api/timetable';
      
      const method = editingLesson ? 'PATCH' : 'POST';
      
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(lessonData),
      });

      if (response.ok) {
        // Refresh data
        mutate();
        alert(editingLesson ? 'Lesson updated successfully!' : 'Lesson created successfully!');
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Failed to save lesson'}`);
      }
    } catch (error) {
      console.error('Error saving lesson:', error);
      throw error;
    }
  };

  // UX IMPROVEMENT: Get color for specific group (color by group, not room)
  const getGroupColor = (groupName: string) => {
    return GROUP_COLORS[groupName] || GROUP_COLORS['default'];
  };

  // UX IMPROVEMENT: Show lessons directly without expansion
  const renderDayCell = (dayIndex: number, room: 'Lecture Room' | 'Computer Lab'): JSX.Element => {
    const dayLessons = getLessonsForDayRoom(dayIndex, room);

    if (dayLessons.length === 0) {
      return (
        <div className="h-full min-h-[80px] flex items-center justify-center p-2">
          {/* UX IMPROVEMENT: Compact empty state */}
          <button
            onClick={() => {
              const targetDate = addDays(dateRange.start, dayIndex);
              handleAddLesson(format(targetDate, 'yyyy-MM-dd'), room);
            }}
            className="text-sm text-slate-400 hover:text-teal-600 hover:bg-teal-50 dark:hover:bg-teal-900/20 px-3 py-2 rounded transition-colors flex items-center gap-2"
          >
            <Plus className="w-4 h-4" />
            <span className="hidden md:inline">Add Session</span>
          </button>
        </div>
      );
    }

    const spaceY = densityMode === 'compact' ? 'space-y-1' : densityMode === 'comfortable' ? 'space-y-2' : 'space-y-3';
    
    return (
      <div className={`${spaceY} p-2`}>
        {dayLessons.map((lesson) => {
          const groupColor = getGroupColor(lesson.group.name);
          const isHovered = hoveredLesson === lesson.id;
          const isHighlighted = highlightedGroup === lesson.group.id;
          const roomIcon = room === 'Lecture Room' ? 'üìç' : 'üíª';

          return (
            <div
              key={lesson.id}
              onMouseEnter={() => setHoveredLesson(lesson.id)}
              onMouseLeave={() => setHoveredLesson(null)}
              className={`
                ${groupColor.bg} ${groupColor.border}
                border-2 rounded-lg overflow-hidden
                transition-all duration-200 cursor-pointer
                ${isHighlighted ? 'ring-4 ring-yellow-400 shadow-xl scale-105' : ''}
                ${isHovered ? 'shadow-lg scale-102 -translate-y-0.5' : ''}
                ${groupColor.hover}
              `}
              onClick={() => handleLessonClick(lesson)}
            >
              {/* UX IMPROVEMENT: Show all info upfront, no expansion needed */}
              <div className={`${groupColor.text} px-3 ${densityMode === 'compact' ? 'py-1.5' : 'py-2'}`}>
                <div className="flex items-start justify-between gap-2">
                  <div className="flex-1 min-w-0">
                    <div className="font-bold text-sm truncate">
                      {roomIcon} {lesson.group.name}
                    </div>
                    {viewMode === 'detailed' && (
                      <>
                        <div className="text-xs opacity-90 mt-0.5">
                          {lesson.module.code} ‚Ä¢ {lesson.startTime}-{lesson.endTime}
                        </div>
                        {lesson.facilitator && (
                          <div className="text-xs opacity-75 mt-0.5">
                            üë§ {lesson.facilitator.name}
                          </div>
                        )}
                      </>
                    )}
                  </div>
                  
                  {/* UX IMPROVEMENT: Quick actions on hover */}
                  {isHovered && (
                    <div className="flex gap-1">
                      <button
                        onClick={(e) => { e.stopPropagation(); alert('Copy lesson'); }}
                        className="p-1 bg-white/20 hover:bg-white/30 rounded"
                        title="Copy"
                      >
                        <Copy className="w-3 h-3" />
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    );
  }

  return (
    <div className="flex h-screen bg-slate-50 dark:bg-slate-900 print:bg-white">
      <Sidebar />
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header />
        <main className="flex-1 overflow-auto p-6">
          <div className="space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between print:mb-4">
              <div>
                <h1 className="text-3xl font-bold text-slate-900 dark:text-white">
                  YEHA Timetable
                </h1>
                <p className="text-slate-600 dark:text-slate-400 mt-1">
                  {viewType === 'week' && `${format(dateRange.start, 'MMM d')} - ${format(dateRange.end, 'MMM d, yyyy')}`}
                  {viewType === 'month' && format(currentDate, 'MMMM yyyy')}
                  {viewType === 'list' && 'All Lessons'}
                  {viewType === 'timeline' && format(currentDate, 'EEEE, MMMM d, yyyy')}
                </p>
              </div>
              <div className="flex items-center gap-2 print:hidden">
                {/* Phase 2: View Type Toggle */}
                <div className="flex items-center gap-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg p-1">
                  <button
                    onClick={() => setViewType('week')}
                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1 ${
                      viewType === 'week'
                        ? 'bg-indigo-500 text-white'
                        : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                    title="Week view"
                  >
                    <LayoutGrid className="w-3.5 h-3.5" />
                    Week
                  </button>
                  <button
                    onClick={() => setViewType('month')}
                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1 ${
                      viewType === 'month'
                        ? 'bg-indigo-500 text-white'
                        : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                    title="Month view"
                  >
                    <Calendar className="w-3.5 h-3.5" />
                    Month
                  </button>
                  <button
                    onClick={() => setViewType('list')}
                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1 ${
                      viewType === 'list'
                        ? 'bg-indigo-500 text-white'
                        : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                    title="List view"
                  >
                    <List className="w-3.5 h-3.5" />
                    List
                  </button>
                  <button
                    onClick={() => setViewType('timeline')}
                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1 ${
                      viewType === 'timeline'
                        ? 'bg-indigo-500 text-white'
                        : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                    title="Timeline view"
                  >
                    <Clock className="w-3.5 h-3.5" />
                    Timeline
                  </button>
                </div>
                {/* UX IMPROVEMENT: Density control for user preference */}
                <div className="flex items-center gap-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg p-1">
                  <button
                    onClick={() => setDensityMode('compact')}
                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${
                      densityMode === 'compact'
                        ? 'bg-teal-500 text-white'
                        : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                    title="Compact view"
                  >
                    Compact
                  </button>
                  <button
                    onClick={() => setDensityMode('comfortable')}
                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${
                      densityMode === 'comfortable'
                        ? 'bg-teal-500 text-white'
                        : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                    title="Comfortable view"
                  >
                    Comfortable
                  </button>
                  <button
                    onClick={() => setDensityMode('spacious')}
                    className={`px-3 py-1.5 rounded text-xs font-medium transition-colors ${
                      densityMode === 'spacious'
                        ? 'bg-teal-500 text-white'
                        : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                    title="Spacious view"
                  >
                    Spacious
                  </button>
                </div>

                {/* UX IMPROVEMENT: Simplified view toggle */}
                <button
                  onClick={() => setViewMode(viewMode === 'simple' ? 'detailed' : 'simple')}
                  className="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2"
                  title="Toggle details"
                >
                  <Filter className="w-4 h-4" />
                  {viewMode === 'simple' ? 'Show Details' : 'Hide Details'}
                </button>
                
                <button
                  onClick={handlePrint}
                  className="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2"
                >
                  <Printer className="w-4 h-4" />
                  <span className="hidden md:inline">Print</span>
                </button>
                <button
                  onClick={() => alert('Add Lesson modal coming soon!')}
                  className="px-4 py-2 bg-gradient-to-r from-teal-500 to-emerald-500 text-white rounded-lg hover:from-teal-600 hover:to-emerald-600 flex items-center gap-2"
                >
                  <Plus className="w-4 h-4" />
                  Add Lesson
                </button>
              </div>
            </div>

            {/* Phase 3: Filter and Search Panel */}
            <FilterPanel
              groups={filterOptions.groups}
              modules={filterOptions.modules}
              facilitators={filterOptions.facilitators}
              selectedGroups={selectedGroupFilters}
              selectedModules={selectedModuleFilters}
              selectedFacilitators={selectedFacilitatorFilters}
              searchQuery={searchQuery}
              onGroupsChange={setSelectedGroupFilters}
              onModulesChange={setSelectedModuleFilters}
              onFacilitatorsChange={setSelectedFacilitatorFilters}
              onSearchChange={setSearchQuery}
              onClearAll={clearAllFilters}
            />

            {/* Controls - Adaptive to view type */}
            {viewType !== 'list' && (
              <div className="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4 print:hidden">
                <div className="flex items-center justify-between gap-4">
                  <div className="flex items-center gap-3">
                    <button
                      onClick={handlePrevious}
                      className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
                    >
                      <ChevronLeft className="w-5 h-5" />
                    </button>
                    
                    <div className="relative">
                      <button
                        onClick={() => setShowDatePicker(!showDatePicker)}
                        className="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 font-medium flex items-center gap-2"
                      >
                        <Calendar className="w-4 h-4" />
                        {viewType === 'week' && `Week of ${format(dateRange.start, 'MMM d')}`}
                        {viewType === 'month' && format(currentDate, 'MMMM yyyy')}
                        {viewType === 'timeline' && format(currentDate, 'MMM d, yyyy')}
                      </button>
                      {showDatePicker && (
                        <div className="absolute top-full mt-2 left-0 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-lg p-4 z-10">
                          <input
                            type="date"
                            value={format(currentDate, 'yyyy-MM-dd')}
                            onChange={(e) => {
                              setCurrentDate(new Date(e.target.value));
                              setShowDatePicker(false);
                            }}
                            className="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900 text-slate-900 dark:text-white"
                          />
                        </div>
                      )}
                    </div>

                    <button
                      onClick={handleNext}
                      className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
                    >
                      <ChevronRight className="w-5 h-5" />
                    </button>
                  </div>
                    </button>
                    {showDatePicker && (
                      <div className="absolute top-full mt-2 left-0 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-lg p-4 z-10">
                        <input
                          type="date"
                          value={format(currentDate, 'yyyy-MM-dd')}
                          onChange={(e) => {
                            setCurrentDate(new Date(e.target.value));
                            setShowDatePicker(false);
                          }}
                          className="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900 text-slate-900 dark:text-white"
                        />
                      </div>
                    )}
                  </div>

                  <button
                    onClick={handleNext}
                    className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
                  >
                  <button
                    onClick={handleNext}
                    className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
                  >
                    <ChevronRight className="w-5 h-5" />
                  </button>
                </div>

                <div className="flex items-center gap-2">
                  <button
                    onClick={() => alert('Bulk operations coming soon!')}
                    className="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2"
                  >
                    <Copy className="w-4 h-4" />
                    Copy To
                  </button>
                </div>
              </div>
              </div>
            )}

            {/* Timetable Grid - Phase 2: Conditional View Rendering */}
            {isLoading ? (
              <div className="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div className="flex items-center justify-center h-96">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-500"></div>
                </div>
              </div>
            ) : (
              <>
                {/* Week View */}
                {viewType === 'week' && (
                  <div className="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="bg-slate-100 dark:bg-slate-700">
                            <th className="border border-slate-300 dark:border-slate-600 p-4 text-left font-bold text-slate-700 dark:text-slate-200 w-24">
                              Time
                            </th>
                            {DAYS.map((day, dayIndex) => (
                              <th
                                key={day}
                                className="border border-slate-300 dark:border-slate-600 p-2 text-center font-bold text-slate-700 dark:text-slate-200"
                              >
                                <div>{day}</div>
                                <div className="text-xs font-normal text-slate-500 dark:text-slate-400">
                                  {format(addDays(dateRange.start, dayIndex), 'MMM d')}
                                </div>
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td className="border border-slate-300 dark:border-slate-600 p-4 text-center font-semibold text-slate-700 dark:text-slate-200 bg-slate-50 dark:bg-slate-750">
                              <div className="text-sm">09:00</div>
                              <div className="text-xs text-slate-500 dark:text-slate-400">to</div>
                              <div className="text-sm">14:00</div>
                            </td>
                            {DAYS.map((day, dayIndex) => (
                              <td
                                key={day}
                                className="border border-slate-300 dark:border-slate-600 p-0 align-top"
                              >
                                <div className="grid grid-cols-2 divide-x divide-slate-300 dark:divide-slate-600 min-h-[200px]">
                                  {/* Lecture Room Column */}
                                  <div className="relative">
                                    <div className="sticky top-0 bg-blue-100 dark:bg-blue-900/20 px-2 py-1 text-xs font-semibold text-blue-800 dark:text-blue-200 text-center border-b border-blue-200 dark:border-blue-800">
                                      üìç Lecture Room
                                    </div>
                                    {renderDayCell(dayIndex, 'Lecture Room')}
                                  </div>

                                  {/* Computer Lab Column */}
                                  <div className="relative">
                                    <div className="sticky top-0 bg-emerald-100 dark:bg-emerald-900/20 px-2 py-1 text-xs font-semibold text-emerald-800 dark:text-emerald-200 text-center border-b border-emerald-200 dark:border-emerald-800">
                                      üíª Computer Lab
                                    </div>
                                    {renderDayCell(dayIndex, 'Computer Lab')}
                                  </div>
                                </div>
                              </td>
                            ))}
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Month View */}
                {viewType === 'month' && (
                  <MonthView
                    lessons={filteredLessons}
                    currentDate={currentDate}
                    onDateChange={setCurrentDate}
                    onLessonClick={handleLessonClick}
                    onAddLesson={(date) => handleAddLesson(date)}
                    groupColors={Object.fromEntries(
                      Object.entries(GROUP_COLORS).map(([key, value]) => [
                        key,
                        `${value.bg} ${value.text}`
                      ])
                    )}
                  />
                )}

                {/* List View */}
                {viewType === 'list' && (
                  <ListView
                    lessons={filteredLessons}
                    onLessonClick={handleLessonClick}
                    groupColors={Object.fromEntries(
                      Object.entries(GROUP_COLORS).map(([key, value]) => [
                        key,
                        `${value.bg} ${value.text}`
                      ])
                    )}
                  />
                )}

                {/* Timeline View */}
                {viewType === 'timeline' && (
                  <TimelineView
                    lessons={filteredLessons}
                    currentDate={currentDate}
                    onDateChange={setCurrentDate}
                    onLessonClick={handleLessonClick}
                    groupColors={Object.fromEntries(
                      Object.entries(GROUP_COLORS).map(([key, value]) => [
                        key,
                        `${value.bg} ${value.border} ${value.text}`
                      ])
                    )}
                  />
                )}
              </>
            )}

            {/* UX IMPROVEMENT: Interactive Legend - Show actual groups with colors */}
            <div className="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4 print:hidden">
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                  <span>Training Groups</span>
                  <span className="text-xs font-normal text-slate-500">Click to highlight</span>
                </h3>
                {highlightedGroup && (
                  <button
                    onClick={() => setHighlightedGroup(null)}
                    className="text-sm text-teal-600 hover:text-teal-700 font-medium"
                  >
                    Clear Filter
                  </button>
                )}
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                {groups.slice(0, 10).map((group) => {
                  const groupColor = getGroupColor(group.name);
                  const isHighlighted = highlightedGroup === group.id;
                  const lessonsCount = filteredLessons.filter(l => l.group.id === group.id).length;
                  
                  return (
                    <button
                      key={group.id}
                      onClick={() => setHighlightedGroup(isHighlighted ? null : group.id)}
                      className={`
                        ${groupColor.bg} ${groupColor.border}
                        border-2 rounded-lg p-2.5 text-left transition-all
                        ${groupColor.text}
                        ${isHighlighted ? 'ring-4 ring-yellow-400 shadow-xl scale-105' : 'hover:shadow-lg hover:scale-102'}
                      `}
                    >
                      <div className="font-bold text-xs truncate mb-1">
                        {group.name}
                      </div>
                      <div className="flex items-center justify-between text-xs opacity-90">
                        <span>{lessonsCount} sessions</span>
                        {group._count?.students && (
                          <span className="flex items-center gap-1">
                            üë• {group._count.students}
                          </span>
                        )}
                      </div>
                    </button>
                  );
                })}
              </div>
              {/* UX IMPROVEMENT: Quick stats */}
              <div className="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600 flex items-center justify-between text-xs text-slate-600 dark:text-slate-400">
                <span>{lessons.length} total sessions this week</span>
                <span>{groups.length} active groups</span>
              </div>
            </div>
          </div>
        </main>

        {/* Lesson Details Modal */}
        {selectedLesson && (
          <LessonDetailsModal
            lesson={selectedLesson}
            isOpen={showLessonDetails}
            onClose={() => {
              setShowLessonDetails(false);
              setSelectedLesson(null);
            }}
            onEdit={handleEditLesson}
            onDelete={handleDeleteLesson}
          />
        )}

        {/* Add/Edit Lesson Modal */}
        <AddLessonModal
          isOpen={showAddLesson}
          onClose={() => {
            setShowAddLesson(false);
            setEditingLesson(null);
            setAddLessonDefaults({});
          }}
          onSubmit={handleSubmitLesson}
          editingLesson={editingLesson}
          defaultDate={addLessonDefaults.date}
          defaultVenue={addLessonDefaults.venue}
          modules={modules}
          facilitators={facilitators}
          groups={groups}
        />
      </div>
    </div>
  );
}

